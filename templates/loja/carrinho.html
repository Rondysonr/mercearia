<!-- filepath: c:\Users\rondyson\mercearia\templates\loja\carrinho.html -->
{% extends "base.html" %}
{% load static %}
{% block content %}
<!-- ============================ COMPONENT 1 ================================= -->
<section class="section-content padding-y bg">
<div class="container">

<div class="row">
    <aside class="col-lg-9">
<div class="card">
<table class="table table-borderless table-shopping-cart">
<thead class="text-muted">
<tr class="small text-uppercase">
  <th scope="col">Produto</th>
  <th scope="col" width="120">Quantidade</th>
  <th scope="col" width="120">Valor</th>
  <th scope="col" width="120">Subtotal</th>
  <th scope="col" class="text-right" width="200"> </th>
</tr>
</thead>
<tbody>
    {% for item in car_items %}
<tr data-produto-id="{% if item.produto %}{{ item.produto.id }}{% else %}bolo_{{ item.id }}{% endif %}" 
    data-preco="{% if item.produto %}{{ item.produto.preco }}{% else %}{{ item.preco_unitario }}{% endif %}">
    <td>
        <figure class="itemside align-items-center">
            <div class="aside">
                {% if item.produto %}
                    <img src="{{item.produto.imagem.url}}" class="img-sm">
                {% else %}
                    <img src="{% static 'images/bolo-default.svg' %}" class="img-sm" style="width: 80px; height: 80px; object-fit: cover;">
                {% endif %}
            </div>
            <figcaption class="info">
                {% if item.produto %}
                    <a href="#" class="title text-dark">{{item.produto.produto_nome}}</a>
                    <p class="text-muted small">{{item.produto.descricao}}</p>
                {% else %}
                    <span class="title text-dark">Bolo Personalizado</span>
                    {% if item.dados_personalizacao %}
                        <div class="text-muted small">
                            {% load custom_filters %}
                            {% with dados=item.dados_personalizacao|parse_json %}
                                <small>
                                    <strong>{{ dados.peso }}kg</strong><br>
                                    Formato: {{ dados.formato }}<br>
                                    Massa: {{ dados.massa }}<br>
                                    Recheio: {{ dados.recheio }}<br>
                                    Cobertura: {{ dados.cobertura }}<br>
                                    {% if dados.enfeite %}Enfeite: {{ dados.enfeite }}<br>{% endif %}
                                    {% if dados.observacoes %}Obs: {{ dados.observacoes }}{% endif %}
                                </small>
                            {% endwith %}
                        </div>
                    {% endif %}
                {% endif %}
            </figcaption>
        </figure>
    </td>
    <td> 
        <div class="col"> 
            <div class="input-group input-spinner">
                <div class="input-group-prepend">
                <button class="btn btn-light btn-minus" type="button" 
                        data-produto-id="{% if item.produto %}{{ item.produto.id }}{% else %}bolo_{{ item.id }}{% endif %}"> 
                    <i class="fa fa-minus"></i> 
                </button>
                </div>
                <input type="text" class="form-control text-center qty-input" value="{{item.quantidade}}" 
                       data-produto-id="{% if item.produto %}{{ item.produto.id }}{% else %}bolo_{{ item.id }}{% endif %}" readonly>
                <div class="input-group-append">
                <button class="btn btn-light btn-plus" type="button" 
                        data-produto-id="{% if item.produto %}{{ item.produto.id }}{% else %}bolo_{{ item.id }}{% endif %}"> 
                    <i class="fa fa-plus"></i> 
                </button>
                </div>
            </div> <!-- input-group.// -->
        </div> <!-- col.// -->
    </td>
    <td> 
        <div class="price-wrap"> 
            {% if item.produto %}
                <var class="price">R$ {{item.produto.preco|floatformat:2}}</var>
            {% else %}
                <var class="price">R$ {{item.preco_unitario|floatformat:2}}</var>
            {% endif %}
        </div> <!-- price-wrap .// -->
    </td>
    <td> 
        <div class="price-wrap"> 
            <var class="price subtotal-item" 
                 data-produto-id="{% if item.produto %}{{ item.produto.id }}{% else %}bolo_{{ item.id }}{% endif %}">
                R$ {{item.subtotal|floatformat:2}}
            </var> 
        </div> <!-- price-wrap .// -->
    </td>
    <td class="text-right"> 
        {% if item.produto %}
            <a href="{% url 'remover_carrinho' item.produto.id %}" class="btn btn-danger btn-sm">Remover</a>
        {% else %}
            <a href="#" onclick="removerBoloPersonalizado({{ item.id }})" class="btn btn-danger btn-sm">Remover</a>
        {% endif %}
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="5" class="text-center">
        <div class="py-5">
            <h5 class="text-muted">Seu carrinho está vazio!</h5>
            <p class="text-muted">Adicione alguns produtos deliciosos ao seu carrinho.</p>
            <a href="{% url 'loja' %}" class="btn btn-primary">
                <i class="fa fa-shopping-bag"></i> Continuar Comprando
            </a>
        </div>
    </td>
</tr>
{% endfor%}
</tbody>
</table>
</div> <!-- card.// -->

    </aside> <!-- col.// -->
    <aside class="col-lg-3">

        <div class="card">
        <div class="card-body">
            <dl class="dlist-align">
              <dt>Subtotal:</dt>
              <dd class="text-right" id="subtotal-total">R$ {{total|floatformat:2}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>Taxa (5%):</dt>
              <dd class="text-right" id="taxa-total">R$ {{taxa|floatformat:2}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>Total:</dt>
              <dd class="text-right text-dark b" id="total-geral"><strong>R$ {{total_geral|floatformat:2}}</strong></dd>
            </dl>
            <hr>
            <p class="text-center mb-3">
                <img src="{% static 'images/misc/payments.png' %}" height="26">
            </p>
            {% if car_items %}
                <a href="#" class="btn btn-primary btn-block"> Finalizar Compra </a>
                <a href="{% url 'loja' %}" class="btn btn-light btn-block">Continuar Comprando</a>
            {% else %}
                <a href="{% url 'loja' %}" class="btn btn-primary btn-block">Começar a Comprar</a>
                <a href="{% url 'bolo_personalizado' %}" class="btn btn-success btn-block">Criar Bolo Personalizado</a>
            {% endif %}
        </div> <!-- card-body.// -->
        </div> <!-- card.// -->

</aside> <!-- col.// -->

</div> <!-- row.// -->
<!-- ============================ COMPONENT 1 END .// ================================= -->

</div> <!-- container .//  -->
</section>

<script>
// JavaScript para controlar quantidade no carrinho e atualizar subtotal
document.addEventListener('DOMContentLoaded', function() {
    
    // Função para calcular subtotal de um item
    function calcularSubtotal(produtoId, quantidade) {
        const row = document.querySelector(`tr[data-produto-id="${produtoId}"]`);
        const preco = parseFloat(row.getAttribute('data-preco'));
        return preco * quantidade;
    }
    
    // Função para atualizar subtotal na tela
    function atualizarSubtotal(produtoId, novoSubtotal) {
        const subtotalElement = document.querySelector(`.subtotal-item[data-produto-id="${produtoId}"]`);
        subtotalElement.textContent = `R$ ${novoSubtotal.toFixed(2)}`;
    }
    
    // Função para recalcular totais
    function recalcularTotais() {
        let total = 0;
        
        // Somar todos os subtotais
        document.querySelectorAll('.subtotal-item').forEach(function(element) {
            const valor = parseFloat(element.textContent.replace('R$ ', '').replace(',', '.'));
            total += valor;
        });
        
        // Calcular taxa de 5%
        const taxa = total * 0.05;
        const totalGeral = total + taxa;
        
        // Atualizar na tela
        document.getElementById('subtotal-total').textContent = `R$ ${total.toFixed(2)}`;
        document.getElementById('taxa-total').textContent = `R$ ${taxa.toFixed(2)}`;
        document.getElementById('total-geral').innerHTML = `<strong>R$ ${totalGeral.toFixed(2)}</strong>`;
    }
    
    // Botão PLUS
    document.querySelectorAll('.btn-plus').forEach(function(button) {
        button.addEventListener('click', function() {
            const produtoId = this.getAttribute('data-produto-id');
            const input = document.querySelector(`.qty-input[data-produto-id="${produtoId}"]`);
            const currentValue = parseInt(input.value);
            const newValue = currentValue + 1;
            
            // Atualizar quantidade
            input.value = newValue;
            
            // Calcular e atualizar subtotal
            const novoSubtotal = calcularSubtotal(produtoId, newValue);
            atualizarSubtotal(produtoId, novoSubtotal);
            
            // Recalcular totais
            recalcularTotais();
            
            // Atualizar no backend para produtos normais
            if (!produtoId.startsWith('bolo_')) {
                atualizarCarrinhoBackend(produtoId, newValue);
            }
        });
    });
    
    // Botão MINUS
    document.querySelectorAll('.btn-minus').forEach(function(button) {
        button.addEventListener('click', function() {
            const produtoId = this.getAttribute('data-produto-id');
            const input = document.querySelector(`.qty-input[data-produto-id="${produtoId}"]`);
            const currentValue = parseInt(input.value);
            
            if (currentValue > 1) {
                const newValue = currentValue - 1;
                
                // Atualizar quantidade
                input.value = newValue;
                
                // Calcular e atualizar subtotal
                const novoSubtotal = calcularSubtotal(produtoId, newValue);
                atualizarSubtotal(produtoId, novoSubtotal);
                
                // Recalcular totais
                recalcularTotais();
                
                // Atualizar no backend para produtos normais
                if (!produtoId.startsWith('bolo_')) {
                    atualizarCarrinhoBackend(produtoId, newValue);
                }
            }
        });
    });
});

// Função para atualizar carrinho no backend via AJAX (opcional)
function atualizarCarrinhoBackend(produtoId, quantidade) {
    fetch(`/carrinho/atualizar/${produtoId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({'quantidade': quantidade})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Carrinho atualizado com sucesso!');
        }
    })
    .catch(error => {
        console.error('Erro ao atualizar carrinho:', error);
    });
}

// Função para remover bolo personalizado
function removerBoloPersonalizado(itemId) {
    if (confirm('Tem certeza que deseja remover este bolo personalizado?')) {
        fetch(`/carrinho/remover-bolo/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao remover item: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao remover item');
        });
    }
}
</script>

{% endblock %}